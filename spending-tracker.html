<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="spendingTracker">Spending Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <style>
        :root {
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: gray;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #ffffff;
            --modal-text: #212529;
            --chart-text: #212529;
            --chart-bg: rgba(0, 0, 0, 0.1);
            --accent-bg: #e9ecef;
            --button-hover-bg: #0056b3;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #218838;
            --button-info-bg: #17a2b8;
            --button-info-hover-bg: #138496;
        }
        [data-theme="dark"] {
            --background-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: #495057;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: #adb5bd;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #343a40;
            --modal-text: #f8f9fa;
            --chart-text: #f8f9fa;
            --chart-bg: rgba(255, 255, 255, 0.1);
            --accent-bg: #495057;
            --button-hover-bg: #1a73e8;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #2ecc71;
            --button-info-bg: #17a2b8;
            --button-info-hover-bg: #1ccad8;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .container, .list-group-item, .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .modal-content {
            background-color: var(--modal-bg);
            color: var(--modal-text);
        }
        .completed { text-decoration: line-through; color: var(--completed-text); }
        .high { background-color: var(--high-bg); color: white; }
        .medium { background-color: #ffc107; color: black; }
        .low { background-color: var(--low-bg); color: white; }
        .notes-collapse { max-height: 100px; overflow-y: auto; }
        .btn-primary, .btn-info, .btn-success, .btn-danger, .btn-warning, .btn-secondary {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--button-hover-bg);
        }
        .btn-success {
            background-color: var(--button-success-bg);
        }
        .btn-success:hover {
            background-color: var(--button-success-hover-bg);
        }
        .btn-info {
            background-color: var(--button-info-bg);
        }
        .btn-info:hover {
            background-color: var(--button-info-hover-bg);
        }
        .spending-entries-table, .shopping-list-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .progress {
            height: 20px;
            margin-bottom: 10px;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        [data-theme="dark"] .progress-bar {
            background-color: #28a745;
        }
        [data-theme="dark"] .table {
            color: var(--text-color);
        }
        [data-theme="dark"] .table th,
        [data-theme="dark"] .table td {
            border-color: var(--border-color);
        }
        canvas {
            max-width: 100%;
            margin-bottom: 20px;
        }
        .action-buttons {
            background-color: var(--accent-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .action-buttons .btn {
            margin: 5px;
        }
        .shopping-item-purchased {
            text-decoration: line-through;
            color: var(--completed-text);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4" data-translate="spendingTracker">Spending Tracker</h1>
        <div class="action-buttons">
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <button class="btn btn-primary" id="spendingTrackerBtn" data-translate="addEntry">Add Spending Entry</button>
                <div>
                    <select id="currencyToggle" class="form-select d-inline-block me-2" style="width: auto;">
                        <option value="NRs">NRs</option>
                        <option value="USD">USD</option>
                        <option value="GBP">GBP</option>
                    </select>
                    <button class="btn btn-secondary me-2" id="themeToggleBtn">Toggle Theme</button>
                    <select id="languageToggle" class="form-select d-inline-block" style="width: auto;">
                        <option value="en" data-translate="english">English</option>
                        <option value="ne" data-translate="nepali">Nepali</option>
                    </select>
                </div>
            </div>
            <div class="d-flex flex-wrap">
                <button class="btn btn-success" id="addIncomeBtn" data-translate="addIncome">Add Income</button>
                <button class="btn btn-danger" id="addExpenseBtn" data-translate="addExpense">Add Expense</button>
                <button class="btn btn-info" id="summaryReportBtn" data-translate="summaryReport">Summary Report</button>
                <button class="btn btn-warning" id="exportExcelBtn" data-translate="exportExcel">Export to Excel</button>
                <button class="btn btn-secondary" id="exportPDFBtn" data-translate="exportPDF">Export to PDF</button>
                <button class="btn btn-primary" id="manageEntriesBtn" data-translate="manageEntries">Manage Entries</button>
                <button class="btn btn-primary" id="setBudgetBtn" data-translate="setBudget">Set Budget</button>
                <button class="btn btn-primary" id="manageCategoriesBtn" data-translate="manageCategories">Manage Categories</button>
                <button class="btn btn-primary" id="shoppingListBtn" data-translate="shoppingList">Shopping List</button>
                <button class="btn btn-primary" id="requestNotificationBtn" data-translate="enableNotifications">Enable Notifications</button>
            </div>
        </div>
    </div>

    <!-- Add Spending Entry Modal -->
    <div class="modal fade" id="spendingTrackerModal" tabindex="-1" aria-labelledby="spendingTrackerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingTrackerModalLabel" data-translate="addSpendingEntryHeader">Add Spending Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="spendingAmount" class="form-label" data-translate="amount">Amount</label>
                        <input type="number" class="form-control" id="spendingAmount" min="0" step="0.01" required>
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="spendingType" class="form-label" data-translate="type">Type</label>
                        <select class="form-select" id="spendingType">
                            <option value="Income" data-translate="income">Income</option>
                            <option value="Expense" data-translate="expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingCategory" class="form-label" data-translate="category">Category</label>
                        <select class="form-select" id="spendingCategory"></select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingDate" class="form-label" data-translate="date">Date</label>
                        <input type="date" class="form-control" id="spendingDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="spendingRecurrence" class="form-label" data-translate="recurrence">Recurrence</label>
                        <select class="form-select" id="spendingRecurrence">
                            <option value="none" data-translate="none">None</option>
                            <option value="daily" data-translate="daily">Daily</option>
                            <option value="weekly" data-translate="weekly">Weekly</option>
                            <option value="monthly" data-translate="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingCurrency" class="form-label" data-translate="currency">Currency</label>
                        <select class="form-select" id="spendingCurrency">
                            <option value="NRs">NRs</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addSpendingBtn" data-translate="addEntry">Add Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Spending Entry Modal -->
    <div class="modal fade" id="editSpendingModal" tabindex="-1" aria-labelledby="editSpendingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSpendingModalLabel" data-translate="editSpendingEntry">Edit Spending Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editSpendingAmount" class="form-label" data-translate="amount">Amount</label>
                        <input type="number" class="form-control" id="editSpendingAmount" min="0" step="0.01" required>
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingType" class="form-label" data-translate="type">Type</label>
                        <select class="form-select" id="editSpendingType">
                            <option value="Income" data-translate="income">Income</option>
                            <option value="Expense" data-translate="expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingCategory" class="form-label" data-translate="category">Category</label>
                        <select class="form-select" id="editSpendingCategory"></select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingDate" class="form-label" data-translate="date">Date</label>
                        <input type="date" class="form-control" id="editSpendingDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingRecurrence" class="form-label" data-translate="recurrence">Recurrence</label>
                        <select class="form-select" id="editSpendingRecurrence">
                            <option value="none" data-translate="none">None</option>
                            <option value="daily" data-translate="daily">Daily</option>
                            <option value="weekly" data-translate="weekly">Weekly</option>
                            <option value="monthly" data-translate="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingCurrency" class="form-label" data-translate="currency">Currency</label>
                        <select class="form-select" id="editSpendingCurrency">
                            <option value="NRs">NRs</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditSpendingBtn" data-translate="save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spending Summary Modal -->
    <div class="modal fade" id="spendingSummaryModal" tabindex="-1" aria-labelledby="spendingSummaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingSummaryModalLabel" data-translate="viewSummary">View Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 data-translate="budgetTitle">Set Monthly Budget</h6>
                    <div id="budgetOverview" class="mb-4"></div>

                    <h6 data-translate="weeklySummary">Weekly Summary (Current Week, Monday to Sunday)</h6>
                    <table class="table mb-4">
                        <thead>
                            <tr>
                                <th data-translate="day">Day</th>
                                <th data-translate="incomeLabel">Income</th>
                                <th data-translate="expenses">Expenses</th>
                                <th data-translate="balance">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="weeklySummary"></tbody>
                    </table>

                    <h6 data-translate="monthlySummary">Monthly Summary</h6>
                    <table class="table mb-4">
                        <thead>
                            <tr>
                                <th data-translate="totalIncome">Total Income</th>
                                <th data-translate="totalExpenses">Total Expenses</th>
                                <th data-translate="netBalance">Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="monthlySummary"></tbody>
                    </table>

                    <h6 data-translate="yearlySummary">Yearly Summary</h6>
                    <table class="table mb-4">
                        <thead>
                            <tr>
                                <th data-translate="totalIncome">Total Income</th>
                                <th data-translate="totalExpenses">Total Expenses</th>
                                <th data-translate="netBalance">Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="yearlySummary"></tbody>
                    </table>

                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="categoryPieChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="monthlyTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
                    <button type="button" class="btn btn-warning" id="exportSpendingExcelBtn" data-translate="exportExcel">Export to Excel</button>
                    <button type="button" class="btn btn-secondary" id="exportSpendingPDFBtn" data-translate="exportPDF">Export to PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Spending Entries Modal -->
    <div class="modal fade" id="manageEntriesModal" tabindex="-1" aria-labelledby="manageEntriesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageEntriesModalLabel" data-translate="manageEntriesTitle">Manage Spending Entries</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchEntries" data-translate-placeholder="searchPlaceholder" placeholder="Search by category or type">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filterType">
                                <option value="all" data-translate="all">All</option>
                                <option value="Income" data-translate="income">Income</option>
                                <option value="Expense" data-translate="expense">Expense</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filterCategory"></select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterStartDate" class="form-label" data-translate="startDate">Start Date</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                        <div class="col-md-6">
                            <label for="filterEndDate" class="form-label" data-translate="endDate">End Date</label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                    </div>
                    <div class="spending-entries-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th data-translate="date">Date</th>
                                    <th data-translate="type">Type</th>
                                    <th data-translate="category">Category</th>
                                    <th data-translate="amount">Amount</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spendingEntriesList"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Set Budget Modal -->
    <div class="modal fade" id="setBudgetModal" tabindex="-1" aria-labelledby="setBudgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setBudgetModalLabel" data-translate="budgetTitle">Set Monthly Budget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="budgetInputs">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBudgetBtn" data-translate="save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageCategoriesModalLabel" data-translate="manageCategories">Manage Categories</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newCategoryInput" class="form-label" data-translate="newCategory">New Category</label>
                        <input type="text" class="form-control" id="newCategoryInput" data-translate-placeholder="categoryName" placeholder="Category Name">
                        <div class="invalid-feedback">Please enter a category name.</div>
                    </div>
                    <button class="btn btn-primary mb-3" id="addCategoryBtn" data-translate="addCategory">Add Category</button>
                    <ul class="list-group" id="categoryList"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shopping List Modal -->
    <div class="modal fade" id="shoppingListModal" tabindex="-1" aria-labelledby="shoppingListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shoppingListModalLabel" data-translate="shoppingList">Shopping List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="shoppingItemName" class="form-label" data-translate="itemName">Item Name</label>
                                <input type="text" class="form-control" id="shoppingItemName" data-translate-placeholder="itemName" placeholder="Item Name">
                                <div class="invalid-feedback">Please enter an item name.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="shoppingItemCategory" class="form-label" data-translate="category">Category</label>
                                <select class="form-select" id="shoppingItemCategory"></select>
                            </div>
                            <div class="col-md-4">
                                <label for="shoppingItemQuantity" class="form-label" data-translate="quantity">Quantity</label>
                                <input type="number" class="form-control" id="shoppingItemQuantity" value="1" min="1">
                            </div>
                        </div>
                        <button class="btn btn-primary mt-2" id="addShoppingItemBtn" data-translate="addItem">Add Item</button>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchShoppingItems" data-translate-placeholder="searchPlaceholder" placeholder="Search by item name">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filterShoppingCategory"></select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filterPurchased">
                                <option value="all" data-translate="all">All</option>
                                <option value="purchased" data-translate="purchased">Purchased</option>
                                <option value="not-purchased" data-translate="notPurchased">Not Purchased</option>
                            </select>
                        </div>
                    </div>
                    <div class="shopping-list-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th data-translate="itemName">Item Name</th>
                                    <th data-translate="category">Category</th>
                                    <th data-translate="quantity">Quantity</th>
                                    <th data-translate="status">Status</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="shoppingListItems"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Shopping Item Modal -->
    <div class="modal fade" id="editShoppingItemModal" tabindex="-1" aria-labelledby="editShoppingItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editShoppingItemModalLabel" data-translate="edit">Edit Shopping Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editShoppingItemName" class="form-label" data-translate="itemName">Item Name</label>
                        <input type="text" class="form-control" id="editShoppingItemName" data-translate-placeholder="itemName" placeholder="Item Name">
                        <div class="invalid-feedback">Please enter an item name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editShoppingItemCategory" class="form-label" data-translate="category">Category</label>
                        <select class="form-select" id="editShoppingItemCategory"></select>
                    </div>
                    <div class="mb-3">
                        <label for="editShoppingItemQuantity" class="form-label" data-translate="quantity">Quantity</label>
                        <input type="number" class="form-control" id="editShoppingItemQuantity" min="1">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editShoppingItemPurchased">
                        <label class="form-check-label" for="editShoppingItemPurchased" data-translate="purchased">Purchased</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditShoppingItemBtn" data-translate="save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Purchase Expense Modal -->
    <div class="modal fade" id="addPurchaseExpenseModal" tabindex="-1" aria-labelledby="addPurchaseExpenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPurchaseExpenseModalLabel">Add Purchase Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="purchaseItemInfo"></p>
                    <div class="mb-3">
                        <label for="purchaseAmount" class="form-label" data-translate="amount">Amount</label>
                        <input type="number" class="form-control" id="purchaseAmount" min="0" step="0.01" required>
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmPurchaseBtn" data-translate="save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js" integrity="sha512-CZHiMc1FvSOk+UzOmO9JTaUFuS9cTkwFgJHXsS9oD+sdvWr2y5c0mYIpM2pC2kzcm5kG5nE3e7l/5u1mU7Hg==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha512-JGPG4N2xX2UZ4ZOHk0UMg3iAanyHPSr3GedHkxQ5CLgCZSGDJgM4rNCD04A2geTb9oO2dXdkkmdmQ7B2u7SQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKFDJsyFJhDoHkzR8yHB1nXrg4wxshP2X2Xmw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js" integrity="sha512-7z3otVycJ7YGLYcANMcW7vRjU+9pGMDdKMTkArhDEv5oM2zGwxLv/MgYAuOgl+UrBFlfYcDTd2kF+8q9W2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js" integrity="sha512-HFJn5geYplTQqR1TF7s1s0pL2Z5yH5nP2fQJGyku8tZ8qT5i0hTAgQb3gq9G5oNKn2kXh/4YOC36//wJqQ6Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="utility.js"></script>
    <script>
        // State Management
        const state = {
            spendingEntries: [],
            shoppingItems: [],
            budgets: {},
            categories: ["Food", "Rent", "Salary", "Utilities", "Entertainment", "Other"],
        };

        const defaultCategories = ["Food", "Rent", "Salary", "Utilities", "Entertainment", "Other"];

        let categoryPieChart, monthlyTrendsChart;

        // Utility Functions
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function saveSpendingEntries() {
            try {
                if (state.spendingEntries.length > 1000) {
                    state.spendingEntries = state.spendingEntries.slice(-1000);
                    console.warn("Spending entries exceeded 1000; older entries have been removed.");
                }
                checkStorageCapacity();
                localStorage.setItem("spendingEntries", minifyJSON(state.spendingEntries));
            } catch (e) {
                console.error("Failed to save spending entries:", e);
                alert("Unable to save spending entries. Please check your browser settings.");
                throw e;
            }
        }

        function saveShoppingItems() {
            try {
                if (state.shoppingItems.length > 500) {
                    state.shoppingItems = state.shoppingItems.slice(-500);
                    console.warn("Shopping items exceeded 500; older items have been removed.");
                }
                checkStorageCapacity();
                localStorage.setItem("shoppingItems", minifyJSON(state.shoppingItems));
            } catch (e) {
                console.error("Failed to save shopping items:", e);
                alert("Unable to save shopping items. Please check your browser settings.");
            }
        }

        function saveCategories() {
            const customCategories = state.categories.filter(cat => !defaultCategories.includes(cat));
            localStorage.setItem("spendingCategories", minifyJSON(customCategories));
            populateCategoryDropdowns();
        }

        function checkRecurringEntries() {
            const today = new Date();
            const todayStr = today.toISOString().split("T")[0];
            state.spendingEntries.forEach((entry, index) => {
                if (entry.recurring && entry.date && new Date(entry.date) < today) {
                    let newDate = new Date(entry.date);
                    while (newDate < today) {
                        if (entry.recurrence === "daily") {
                            newDate.setDate(newDate.getDate() + 1);
                        } else if (entry.recurrence === "weekly") {
                            newDate.setDate(newDate.getDate() + 7);
                        } else if (entry.recurrence === "monthly") {
                            newDate.setMonth(newDate.getMonth() + 1);
                        }
                    }
                    state.spendingEntries[index].date = newDate.toISOString().split("T")[0];
                    if (newDate > today) {
                        state.spendingEntries[index].recurring = true;
                    } else {
                        state.spendingEntries.push({
                            ...entry,
                            date: newDate.toISOString().split("T")[0],
                            recurring: false
                        });
                        state.spendingEntries[index].recurring = false;
                    }
                }
            });
            saveSpendingEntries();
            setTimeout(checkRecurringEntries, 5 * 60 * 1000);
        }

        function convertToDefaultCurrency(amount, currency) {
            const defaultCurrency = localStorage.getItem("defaultCurrency") || "NRs";
            const exchangeRates = {
                "NRs": 1,
                "USD": 0.0074,
                "GBP": 0.0056
            };
            if (currency === defaultCurrency) return amount;
            const amountInNRs = amount / exchangeRates[currency];
            return amountInNRs * exchangeRates[defaultCurrency];
        }

        function populateCategoryDropdowns() {
            const dropdowns = [
                "spendingCategory",
                "editSpendingCategory",
                "filterCategory",
                "shoppingItemCategory",
                "editShoppingItemCategory",
                "filterShoppingCategory"
            ];
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                const currentValue = dropdown.value;
                const options = state.categories.map(category => {
                    const option = document.createElement("option");
                    option.value = category;
                    option.textContent = getTranslation(category.toLowerCase()) || category;
                    return option;
                });
                dropdown.innerHTML = "";
                if (dropdownId === "filterCategory" || dropdownId === "filterShoppingCategory") {
                    const allOption = document.createElement("option");
                    allOption.value = "all";
                    allOption.textContent = getTranslation("all");
                    dropdown.appendChild(allOption);
                }
                options.forEach(option => dropdown.appendChild(option));
                dropdown.value = currentValue in state.categories ? currentValue : state.categories[0];
            });
        }
    </script>
    <script src="spending-tracker-script.js"></script>
</body>
</html>
