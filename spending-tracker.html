<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spending Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="icon" href="data:,">
    <style>
        :root {
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: gray;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #ffffff;
            --modal-text: #212529;
            --chart-text: #212529;
            --chart-bg: rgba(0, 0, 0, 0.1);
            --accent-bg: #e9ecef;
            --button-hover-bg: #0056b3;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #218838;
            --button-info-bg: #17a2b8;
            --button-info-hover-bg: #138496;
            --navbar-bg: #ffffff;
            --navbar-text: #212529;
            --navbar-hover-bg: #e9ecef;
        }
        [data-theme="dark"] {
            --background-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: #495057;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: #adb5bd;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #343a40;
            --modal-text: #f8f9fa;
            --chart-text: #f8f9fa;
            --chart-bg: rgba(255, 255, 255, 0.1);
            --accent-bg: #495057;
            --button-hover-bg: #1a73e8;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #2ecc71;
            --button-info-bg: #17a2b8;
            --button-info-hover-bg: #1ccad8;
            --navbar-bg: #343a40;
            --navbar-text: #f8f9fa;
            --navbar-hover-bg: #495057;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .container, .list-group-item, .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .modal-content {
            background-color: var(--modal-bg);
            color: var(--modal-text);
        }
        .completed { text-decoration: line-through; color: var(--completed-text); }
        .high { background-color: var(--high-bg); color: white; }
        .medium { background-color: #ffc107; color: black; }
        .low { background-color: var(--low-bg); color: white; }
        .notes-collapse { max-height: 100px; overflow-y: auto; }
        .btn-primary, .btn-info, .btn-success, .btn-danger, .btn-warning, .btn-secondary {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--button-hover-bg);
        }
        .btn-success {
            background-color: var(--button-success-bg);
        }
        .btn-success:hover {
            background-color: var(--button-success-hover-bg);
        }
        .btn-info {
            background-color: var(--button-info-bg);
        }
        .btn-info:hover {
            background-color: var(--button-info-hover-bg);
        }
        .spending-entries-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .progress {
            height: 20px;
            margin-bottom: 10px;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        [data-theme="dark"] .progress-bar {
            background-color: #28a745;
        }
        [data-theme="dark"] .table {
            color: var(--text-color);
        }
        [data-theme="dark"] .table th,
        [data-theme="dark"] .table td {
            border-color: var(--border-color);
        }
        canvas {
            max-width: 100%;
            margin-bottom: 20px;
        }
        .action-buttons {
            background-color: var(--accent-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .action-buttons .btn {
            margin: 5px;
        }
        .navbar {
            background-color: var(--navbar-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand, .nav-link, .dropdown-item {
            color: var(--navbar-text) !important;
        }
        .dropdown-item:hover {
            background-color: var(--navbar-hover-bg);
        }
        .dropdown-item.active {
            background-color: var(--button-bg);
            color: var(--button-text) !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">Task & Expense Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Navigate
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="index.html">Home</a></li>
                            <li><a class="dropdown-item" href="todo-list.html">To-Do List</a></li>
                            <li><a class="dropdown-item active" href="spending-tracker.html">Spending Tracker</a></li>
                            <li><a class="dropdown-item" href="shopping-list.html">Shopping List</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <select id="currencyToggle" class="form-select d-inline-block me-2" style="width: auto;">
                            <option value="NRs">NRs</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-primary" id="themeToggleBtn">Toggle Theme</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="mb-4">Spending Tracker</h1>
        <div class="action-buttons">
            <div class="d-flex flex-wrap">
                <button class="btn btn-primary" id="spendingTrackerBtn">Add Spending Entry</button>
                <button class="btn btn-success" id="addIncomeBtn">Add Income</button>
                <button class="btn btn-danger" id="addExpenseBtn">Add Expense</button>
                <button class="btn btn-info" id="summaryReportBtn">Summary Report</button>
                <button class="btn btn-warning" id="exportExcelBtn">Export to Excel</button>
                <button class="btn btn-secondary" id="exportPDFBtn">Export to PDF</button>
                <button class="btn btn-primary" id="manageEntriesBtn">Manage Entries</button>
                <button class="btn btn-primary" id="setBudgetBtn">Set Budget</button>
                <button class="btn btn-primary" id="manageCategoriesBtn">Manage Categories</button>
            </div>
        </div>
    </div>

    <!-- Add Spending Entry Modal -->
    <div class="modal fade" id="spendingTrackerModal" tabindex="-1" aria-labelledby="spendingTrackerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingTrackerModalLabel">Add Spending Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="spendingAmount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="spendingAmount" min="0" step="0.01" required>
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="spendingType" class="form-label">Type</label>
                        <select class="form-select" id="spendingType">
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingCategory" class="form-label">Category</label>
                        <select class="form-select" id="spendingCategory"></select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="spendingDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="spendingCurrency" class="form-label">Currency</label>
                        <select class="form-select" id="spendingCurrency">
                            <option value="NRs">NRs</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addSpendingBtn">Add Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Spending Entry Modal -->
    <div class="modal fade" id="editSpendingModal" tabindex="-1" aria-labelledby="editSpendingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSpendingModalLabel">Edit Spending Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editSpendingAmount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="editSpendingAmount" min="0" step="0.01" required>
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingType" class="form-label">Type</label>
                        <select class="form-select" id="editSpendingType">
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingCategory" class="form-label">Category</label>
                        <select class="form-select" id="editSpendingCategory"></select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editSpendingDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingCurrency" class="form-label">Currency</label>
                        <select class="form-select" id="editSpendingCurrency">
                            <option value="NRs">NRs</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditSpendingBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spending Summary Modal -->
    <div class="modal fade" id="spendingSummaryModal" tabindex="-1" aria-labelledby="spendingSummaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingSummaryModalLabel">View Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Set Monthly Budget</h6>
                    <div id="budgetOverview" class="mb-4"></div>

                    <h6>Weekly Summary (Current Week, Monday to Sunday)</h6>
                    <table class="table mb-4">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Income</th>
                                <th>Expenses</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="weeklySummary"></tbody>
                    </table>

                    <h6>Monthly Summary</h6>
                    <table class="table mb-4">
                        <thead>
                            <tr>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="monthlySummary"></tbody>
                    </table>

                    <h6>Yearly Summary</h6>
                    <table class="table mb-4">
                        <thead>
                            <tr>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="yearlySummary"></tbody>
                    </table>

                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="categoryPieChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="monthlyTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="exportSpendingExcelBtn">Export to Excel</button>
                    <button type="button" class="btn btn-secondary" id="exportSpendingPDFBtn">Export to PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Spending Entries Modal -->
    <div class="modal fade" id="manageEntriesModal" tabindex="-1" aria-labelledby="manageEntriesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageEntriesModalLabel">Manage Spending Entries</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchEntries" placeholder="Search by category or type">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filterType">
                                <option value="all">All</option>
                                <option value="Income">Income</option>
                                <option value="Expense">Expense</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filterCategory"></select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterStartDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                        <div class="col-md-6">
                            <label for="filterEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                    </div>
                    <div class="spending-entries-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spendingEntriesList"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Set Budget Modal -->
    <div class="modal fade" id="setBudgetModal" tabindex="-1" aria-labelledby="setBudgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setBudgetModalLabel">Set Monthly Budget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="budgetInputs">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBudgetBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageCategoriesModalLabel">Manage Categories</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newCategoryInput" class="form-label">New Category</label>
                        <input type="text" class="form-control" id="newCategoryInput" placeholder="Category Name">
                        <div class="invalid-feedback">Please enter a category name.</div>
                    </div>
                    <button class="btn btn-primary mb-3" id="addCategoryBtn">Add Category</button>
                    <ul class="list-group" id="categoryList"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script src="lib/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="lib/purify.min.js"></script>
    <script src="utility.js"></script>
    <script>
        // State Management
        const state = {
            spendingEntries: [],
            budgets: {},
            categories: ["Food", "Rent", "Salary", "Utilities", "Entertainment", "Other"],
        };

        const defaultCategories = ["Food", "Rent", "Salary", "Utilities", "Entertainment", "Other"];

        let categoryPieChart, monthlyTrendsChart;

        // Utility Functions
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function saveSpendingEntries() {
            try {
                if (state.spendingEntries.length > 1000) {
                    state.spendingEntries = state.spendingEntries.slice(-1000);
                    console.warn("Spending entries exceeded 1000; older entries have been removed.");
                }
                checkStorageCapacity();
                localStorage.setItem("spendingEntries", minifyJSON(state.spendingEntries));
            } catch (e) {
                console.error("Failed to save spending entries:", e);
                alert("Unable to save spending entries. Please check your browser settings.");
                throw e;
            }
        }

        function convertToDefaultCurrency(amount, currency) {
            const defaultCurrency = localStorage.getItem("defaultCurrency") || "NRs";
            const exchangeRates = {
                "NRs": 1,
                "USD": 0.0074,
                "GBP": 0.0056
            };
            if (currency === defaultCurrency) return amount;
            const amountInNRs = amount / exchangeRates[currency];
            return amountInNRs * exchangeRates[defaultCurrency];
        }

        function populateCategoryDropdowns() {
            const dropdowns = [
                "spendingCategory",
                "editSpendingCategory",
                "filterCategory"
            ];
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                const currentValue = dropdown.value;
                const options = state.categories.map(category => {
                    const option = document.createElement("option");
                    option.value = category;
                    option.textContent = category;
                    return option;
                });
                dropdown.innerHTML = "";
                if (dropdownId === "filterCategory") {
                    const allOption = document.createElement("option");
                    allOption.value = "all";
                    allOption.textContent = "All";
                    dropdown.appendChild(allOption);
                }
                options.forEach(option => dropdown.appendChild(option));
                dropdown.value = currentValue in state.categories ? currentValue : state.categories[0];
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            applyTheme();
            document.getElementById("themeToggleBtn").addEventListener("click", toggleTheme);
        });
    </script>
    <script src="spending-tracker-script.js"></script>
</body>
</html>