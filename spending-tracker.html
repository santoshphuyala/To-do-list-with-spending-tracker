<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="spendingTracker">Spending Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: gray;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #ffffff;
            --modal-text: #212529;
            --chart-text: #212529;
            --chart-bg: rgba(0, 0, 0, 0.1);
            --accent-bg: #e9ecef;
            --button-hover-bg: #0056b3;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #218838;
            --button-info-bg: #17a2b8;
            --button-info-hover-bg: #138496;
        }
        [data-theme="dark"] {
            --background-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: #495057;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: #adb5bd;
            --high-bg: #dc3545;
            --medium-bg: #ffc107;
            --low-bg: #28a745;
            --modal-bg: #343a40;
            --modal-text: #f8f9fa;
            --chart-text: #f8f9fa;
            --chart-bg: rgba(255, 255, 255, 0.1);
            --accent-bg: #495057;
            --button-hover-bg: #1a73e8;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #2ecc71;
            --button-info-bg: #17a2b8;
            --button-info-hover-bg: #1ccad8;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .container, .list-group-item, .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .modal-content {
            background-color: var(--modal-bg);
            color: var(--modal-text);
        }
        .completed { text-decoration: line-through; color: var(--completed-text); }
        .high { background-color: var(--high-bg); color: white; }
        .medium { background-color: var(--medium-bg); color: black; }
        .low { background-color: var(--low-bg); color: white; }
        .notes-collapse { max-height: 100px; overflow-y: auto; }
        .btn-primary, .btn-info, .btn-success, .btn-danger, .btn-warning, .btn-secondary {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--button-hover-bg);
        }
        .btn-success {
            background-color: var(--button-success-bg);
        }
        .btn-success:hover {
            background-color: var(--button-success-hover-bg);
        }
        .btn-info {
            background-color: var(--button-info-bg);
        }
        .btn-info:hover {
            background-color: var(--button-info-hover-bg);
        }
        .spending-entries-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .progress {
            height: 20px;
            margin-bottom: 10px;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        [data-theme="dark"] .progress-bar {
            background-color: #28a745;
        }
        [data-theme="dark"] .table {
            color: var(--text-color);
        }
        [data-theme="dark"] .table th,
        [data-theme="dark"] .table td {
            border-color: var(--border-color);
        }
        canvas {
            max-width: 100%;
            margin-bottom: 20px;
        }
        .action-buttons {
            background-color: var(--accent-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .action-buttons .btn {
            margin: 5px;
            width: 100%;
            font-weight: 500;
            border-radius: 8px;
        }
        @media (min-width: 768px) {
            .action-buttons .btn {
                width: auto;
            }
        }
    </style>
</head>
<body class="container py-5">
    <h2 class="text-center mb-4" data-translate="spendingTracker">Spending Tracker</h2>

    <div class="mb-3 d-flex justify-content-between align-items-center">
        <button class="btn btn-primary" id="spendingTrackerBtn" data-translate="addEntry">Add Spending Entry</button>
        <div>
            <select id="languageToggle" class="form-select d-inline-block" style="width: auto;">
                <option value="en" data-translate="english">English</option>
                <option value="ne" data-translate="nepali">Nepali</option>
            </select>
        </div>
    </div>

    <!-- New Add Spending Entry Section -->
    <div class="action-buttons">
        <h4 class="mb-3" data-translate="addSpendingEntryHeader">Add Spending Entry</h4>
        <div class="row g-2">
            <div class="col-12 col-md-4 col-lg-2">
                <button class="btn btn-success" id="addIncomeBtn" data-translate="addIncome">Add Income</button>
            </div>
            <div class="col-12 col-md-4 col-lg-2">
                <button class="btn btn-danger" id="addExpenseBtn" data-translate="addExpense">Add Expense</button>
            </div>
            <div class="col-12 col-md-4 col-lg-2">
                <button class="btn btn-info" id="summaryReportBtn" data-translate="summaryReport">Summary Report</button>
            </div>
            <div class="col-12 col-md-6 col-lg-2">
                <button class="btn btn-primary" id="exportExcelBtn" data-translate="exportExcel">Export to Excel</button>
            </div>
            <div class="col-12 col-md-6 col-lg-2">
                <button class="btn btn-primary" id="exportPDFBtn" data-translate="exportPDF">Export to PDF</button>
            </div>
        </div>
    </div>

    <!-- Spending Tracker Modal -->
    <div class="modal fade" id="spendingTrackerModal" tabindex="-1" aria-labelledby="spendingTrackerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingTrackerModalLabel" data-translate="spendingTracker">Spending Tracker</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="spendingAmount" class="form-label" data-translate="amount">Amount</label>
                        <input type="number" id="spendingAmount" class="form-control" placeholder="Enter amount" min="0" step="0.01" aria-label="Spending amount">
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="spendingType" class="form-label" data-translate="type">Type</label>
                        <select id="spendingType" class="form-select" aria-label="Spending type">
                            <option value="Income" data-translate="income">Income</option>
                            <option value="Expense" data-translate="expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingCategory" class="form-label" data-translate="category">Category</label>
                        <select id="spendingCategory" class="form-select" aria-label="Spending category">
                            <option value="Food" data-translate="food">Food</option>
                            <option value="Rent" data-translate="rent">Rent</option>
                            <option value="Salary" data-translate="salary">Salary</option>
                            <option value="Utilities" data-translate="utilities">Utilities</option>
                            <option value="Entertainment" data-translate="entertainment">Entertainment</option>
                            <option value="Other" data-translate="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingDate" class="form-label" data-translate="date">Date</label>
                        <input type="date" id="spendingDate" class="form-control" aria-label="Spending date">
                    </div>
                    <div class="mb-3">
                        <label for="spendingRecurrence" class="form-label" data-translate="recurrence">Recurrence</label>
                        <select id="spendingRecurrence" class="form-select" aria-label="Spending recurrence">
                            <option value="none" data-translate="none">None</option>
                            <option value="daily" data-translate="daily">Daily</option>
                            <option value="weekly" data-translate="weekly">Weekly</option>
                            <option value="monthly" data-translate="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spendingCurrency" class="form-label" data-translate="currency">Currency</label>
                        <select id="spendingCurrency" class="form-select" aria-label="Spending currency">
                            <option value="NRs">NRs</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addSpendingBtn" data-translate="addEntry">Add Entry</button>
                    <button type="button" class="btn btn-info" id="viewSummaryBtn" data-translate="viewSummary">View Summary</button>
                    <button type="button" class="btn btn-warning" id="manageEntriesBtn" data-translate="manageEntries">Manage Entries</button>
                    <button type="button" class="btn btn-success" id="setBudgetBtn" data-translate="setBudget">Set Budget</button>
                    <button type="button" class="btn btn-info" id="manageCategoriesBtn" data-translate="manageCategories">Manage Categories</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spending Summary Modal -->
    <div class="modal fade" id="spendingSummaryModal" tabindex="-1" aria-labelledby="spendingSummaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spendingSummaryModalLabel" data-translate="viewSummary">Spending Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Budget Overview -->
                    <h6 data-translate="budgetTitle">Set Monthly Budget</h6>
                    <div id="budgetOverview" class="mb-4"></div>

                    <!-- Weekly Summary -->
                    <h6 data-translate="weeklySummary">Weekly Summary (Current Week, Monday to Sunday)</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th data-translate="day">Day</th>
                                <th data-translate="incomeLabel">Income</th>
                                <th data-translate="expenses">Expenses</th>
                                <th data-translate="balance">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="weeklySummary"></tbody>
                    </table>

                    <!-- Monthly Summary -->
                    <h6 data-translate="monthlySummary">Monthly Summary</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th data-translate="totalIncome">Total Income</th>
                                <th data-translate="totalExpenses">Total Expenses</th>
                                <th data-translate="netBalance">Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="monthlySummary"></tbody>
                    </table>

                    <!-- Yearly Summary -->
                    <h6 data-translate="yearlySummary">Yearly Summary</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th data-translate="totalIncome">Total Income</th>
                                <th data-translate="totalExpenses">Total Expenses</th>
                                <th data-translate="netBalance">Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="yearlySummary"></tbody>
                    </table>

                    <!-- Charts -->
                    <h6 data-translate="categoryWiseExpenses">Category-wise Expenses</h6>
                    <canvas id="categoryPieChart"></canvas>
                    <h6 data-translate="monthlyTrends">Monthly Trends (Last 6 Months)</h6>
                    <canvas id="monthlyTrendsChart"></canvas>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" id="exportSpendingExcelBtn" data-translate="exportExcel">Export to Excel</button>
                    <button type="button" class="btn btn-info" id="exportSpendingPDFBtn" data-translate="exportPDF">Export to PDF</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Spending Entries Modal -->
    <div class="modal fade" id="manageEntriesModal" tabindex="-1" aria-labelledby="manageEntriesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageEntriesModalLabel" data-translate="manageEntriesTitle">Manage Spending Entries</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Search and Filter -->
                    <div class="mb-3">
                        <input type="text" id="searchEntries" class="form-control mb-2" data-translate-placeholder="searchPlaceholder" placeholder="Search by category or type">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="filterType" class="form-label" data-translate="filterByType">Filter by Type</label>
                                <select id="filterType" class="form-select">
                                    <option value="all" data-translate="all">All</option>
                                    <option value="Income" data-translate="income">Income</option>
                                    <option value="Expense" data-translate="expense">Expense</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filterCategory" class="form-label" data-translate="filterByCategory">Filter by Category</label>
                                <select id="filterCategory" class="form-select">
                                    <option value="all" data-translate="all">All</option>
                                    <option value="Food" data-translate="food">Food</option>
                                    <option value="Rent" data-translate="rent">Rent</option>
                                    <option value="Salary" data-translate="salary">Salary</option>
                                    <option value="Utilities" data-translate="utilities">Utilities</option>
                                    <option value="Entertainment" data-translate="entertainment">Entertainment</option>
                                    <option value="Other" data-translate="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" data-translate="dateRange">Date Range</label>
                                <div class="d-flex">
                                    <input type="date" id="filterStartDate" class="form-control me-2" data-translate-placeholder="startDate" placeholder="Start Date">
                                    <input type="date" id="filterEndDate" class="form-control" data-translate-placeholder="endDate" placeholder="End Date">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="spending-entries-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th data-translate="date">Date</th>
                                    <th data-translate="type">Type</th>
                                    <th data-translate="category">Category</th>
                                    <th data-translate="amount">Amount</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spendingEntriesList"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Spending Entry Modal -->
    <div class="modal fade" id="editSpendingModal" tabindex="-1" aria-labelledby="editSpendingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSpendingModalLabel" data-translate="editSpendingEntry">Edit Spending Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editSpendingAmount" class="form-label" data-translate="amount">Amount</label>
                        <input type="number" id="editSpendingAmount" class="form-control" placeholder="Enter amount" min="0" step="0.01" aria-label="Edit spending amount">
                        <div class="invalid-feedback">Please enter a valid amount.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingType" class="form-label" data-translate="type">Type</label>
                        <select id="editSpendingType" class="form-select" aria-label="Edit spending type">
                            <option value="Income" data-translate="income">Income</option>
                            <option value="Expense" data-translate="expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingCategory" class="form-label" data-translate="category">Category</label>
                        <select id="editSpendingCategory" class="form-select" aria-label="Edit spending category">
                            <option value="Food" data-translate="food">Food</option>
                            <option value="Rent" data-translate="rent">Rent</option>
                            <option value="Salary" data-translate="salary">Salary</option>
                            <option value="Utilities" data-translate="utilities">Utilities</option>
                            <option value="Entertainment" data-translate="entertainment">Entertainment</option>
                            <option value="Other" data-translate="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingDate" class="form-label" data-translate="date">Date</label>
                        <input type="date" id="editSpendingDate" class="form-control" aria-label="Edit spending date">
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingRecurrence" class="form-label" data-translate="recurrence">Recurrence</label>
                        <select id="editSpendingRecurrence" class="form-select" aria-label="Edit spending recurrence">
                            <option value="none" data-translate="none">None</option>
                            <option value="daily" data-translate="daily">Daily</option>
                            <option value="weekly" data-translate="weekly">Weekly</option>
                            <option value="monthly" data-translate="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpendingCurrency" class="form-label" data-translate="currency">Currency</label>
                        <select id="editSpendingCurrency" class="form-select" aria-label="Edit spending currency">
                            <option value="NRs">NRs</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditSpendingBtn" data-translate="save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Set Budget Modal -->
    <div class="modal fade" id="setBudgetModal" tabindex="-1" aria-labelledby="setBudgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setBudgetModalLabel" data-translate="budgetTitle">Set Monthly Budget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="budgetInputs">
                    <p data-translate="budgetOptional">Budget setting is optional. Click 'Save' to set budgets, or 'Cancel' to skip.</p>
                    <!-- Budget inputs will be dynamically generated -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBudgetBtn" data-translate="save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageCategoriesModalLabel" data-translate="manageCategories">Manage Categories</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newCategoryInput" class="form-label" data-translate="newCategory">New Category</label>
                        <div class="input-group">
                            <input type="text" id="newCategoryInput" class="form-control" data-translate-placeholder="categoryName" placeholder="Category Name">
                            <button class="btn btn-primary" id="addCategoryBtn" data-translate="addCategory">Add Category</button>
                        </div>
                        <div class="invalid-feedback">Category name cannot be empty.</div>
                    </div>
                    <h6 data-translate="category">Categories</h6>
                    <ul id="categoryList" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="utils.js"></script>
    <script>
(function () {
    // State management
    const state = {
        spendingEntries: [],
        budgets: {},
        categories: ["Food", "Rent", "Salary", "Utilities", "Entertainment", "Other"]
    };

    let currentEditSpendingIndex = null;
    let categoryPieChart = null;
    let monthlyTrendsChart = null;
    const { jsPDF } = window.jspdf;

    // Default categories that cannot be deleted
    const defaultCategories = ["Food", "Rent", "Salary", "Utilities", "Entertainment", "Other"];

    // Listen for theme changes from parent
    window.addEventListener('message', (event) => {
        if (event.data && event.data.theme) {
            document.documentElement.setAttribute('data-theme', event.data.theme);
            updateCharts();
        }
    });

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
        try {
            const storedSpending = localStorage.getItem("spendingEntries");
            if (storedSpending) {
                state.spendingEntries = parseMinifiedJSON(storedSpending);
            }
            const storedBudgets = localStorage.getItem("spendingBudgets");
            if (storedBudgets) {
                state.budgets = parseMinifiedJSON(storedBudgets);
            }
            const storedCategories = localStorage.getItem("spendingCategories");
            if (storedCategories) {
                const customCategories = parseMinifiedJSON(storedCategories);
                state.categories = [...defaultCategories, ...customCategories];
            }
            const storedLanguage = localStorage.getItem("selectedLanguage");
            if (storedLanguage) {
                document.getElementById("languageToggle").value = storedLanguage;
            }
        } catch (e) {
            console.error("Failed to load data:", e);
            alert("Unable to load data. Please check your browser settings.");
        }
        document.getElementById("spendingDate").value = new Date().toISOString().split("T")[0];
        applyTheme();
        applyTranslations();
        initializeEventListeners();
        populateCategoryDropdowns();
        checkRecurringEntries();
        requestNotificationPermission();
    });

    /**
     * Request notification permission for budget alerts
     */
    function requestNotificationPermission() {
        if ('Notification' in window) {
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                    }
                });
            }
        }
    }

    /**
     * Initializes all event listeners for buttons.
     */
    function initializeEventListeners() {
        document.getElementById("spendingTrackerBtn").addEventListener("click", openSpendingTrackerModal);
        document.getElementById("addIncomeBtn").addEventListener("click", () => openSpendingTrackerModal("Income"));
        document.getElementById("addExpenseBtn").addEventListener("click", () => openSpendingTrackerModal("Expense"));
        document.getElementById("summaryReportBtn").addEventListener("click", showSpendingSummary);
        document.getElementById("exportExcelBtn").addEventListener("click", exportSpendingToExcel);
        document.getElementById("exportPDFBtn").addEventListener("click", exportSpendingToPDF);
        document.getElementById("addSpendingBtn").addEventListener("click", addSpendingEntry);
        document.getElementById("viewSummaryBtn").addEventListener("click", showSpendingSummary);
        document.getElementById("manageEntriesBtn").addEventListener("click", showManageEntries);
        document.getElementById("setBudgetBtn").addEventListener("click", openSetBudgetModal);
        document.getElementById("manageCategoriesBtn").addEventListener("click", openManageCategoriesModal);
        document.getElementById("exportSpendingExcelBtn").addEventListener("click", exportSpendingToExcel);
        document.getElementById("exportSpendingPDFBtn").addEventListener("click", exportSpendingToPDF);
        document.getElementById("saveEditSpendingBtn").addEventListener("click", saveEditedSpendingEntry);
        document.getElementById("saveBudgetBtn").addEventListener("click", saveBudgets);
        document.getElementById("addCategoryBtn").addEventListener("click", addCategory);
        document.getElementById("languageToggle").addEventListener("change", () => {
            const lang = document.getElementById("languageToggle").value;
            localStorage.setItem("selectedLanguage", lang);
            applyTranslations();
            populateCategoryDropdowns();
            showManageEntries();
            showSpendingSummary();
        });
        document.getElementById("searchEntries").addEventListener("input", debounce(() => {
            showManageEntries();
        }, 300));
        document.getElementById("filterType").addEventListener("change", showManageEntries);
        document.getElementById("filterCategory").addEventListener("change", showManageEntries);
        document.getElementById("filterStartDate").addEventListener("change", showManageEntries);
        document.getElementById("filterEndDate").addEventListener("change", showManageEntries);

        // Keyboard navigation for buttons
        document.querySelectorAll(".btn").forEach(btn => {
            btn.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    btn.click();
                    e.preventDefault();
                }
            });
        });
    }

    /**
     * Saves spending entries to localStorage.
     */
    function saveSpendingEntries() {
        try {
            checkStorageCapacity();
            localStorage.setItem("spendingEntries", minifyJSON(state.spendingEntries));
        } catch (e) {
            console.error("Failed to save spending entries:", e);
            alert("Unable to save spending entries. Please check your browser settings.");
            throw e;
        }
    }

    /**
     * Saves budgets to localStorage.
     */
    function saveBudgets() {
        try {
            const newBudgets = {};
            state.categories.forEach(category => {
                const budgetInput = document.getElementById(`budget-${category}`);
                const budgetValue = parseFloat(budgetInput.value) || 0;
                if (budgetValue > 0) {
                    newBudgets[category] = budgetValue;
                }
            });
            state.budgets = newBudgets;
            localStorage.setItem("spendingBudgets", minifyJSON(state.budgets));
            bootstrap.Modal.getInstance(document.getElementById("setBudgetModal")).hide();
            showSpendingSummary();
        } catch (e) {
            console.error("Failed to save budgets:", e);
            alert("Failed to save budgets. Please try again.");
        }
    }

    /**
     * Saves custom categories to localStorage.
     */
    function saveCategories() {
        try {
            const customCategories = state.categories.filter(cat => !defaultCategories.includes(cat));
            localStorage.setItem("spendingCategories", minifyJSON(customCategories));
            populateCategoryDropdowns();
        } catch (e) {
            console.error("Failed to save categories:", e);
            alert("Failed to save categories. Please try again.");
        }
    }

    /**
     * Opens the spending tracker modal, optionally pre-selecting the type.
     */
    function openSpendingTrackerModal(type = null) {
        document.getElementById("spendingAmount").value = "";
        document.getElementById("spendingAmount").classList.remove("is-invalid");
        document.getElementById("spendingType").value = type || "Income";
        document.getElementById("spendingCategory").value = "Food";
        document.getElementById("spendingDate").value = new Date().toISOString().split("T")[0];
        document.getElementById("spendingRecurrence").value = "none";
        document.getElementById("spendingCurrency").value = localStorage.getItem("defaultCurrency") || "NRs";
        new bootstrap.Modal(document.getElementById("spendingTrackerModal")).show();
    }

    /**
     * Opens the set budget modal.
     */
    function openSetBudgetModal() {
        const budgetInputs = document.getElementById("budgetInputs");
        budgetInputs.innerHTML = '<p data-translate="budgetOptional">Budget setting is optional. Click \'Save\' to set budgets, or \'Cancel\' to skip.</p>';
        state.categories.forEach(category => {
            const div = document.createElement("div");
            div.className = "mb-3";
            div.innerHTML = `
                <label for="budget-${category}" class="form-label" data-translate="budgetFor">${getTranslation("budgetFor")} ${category}</label>
                <input type="number" id="budget-${category}" class="form-control" value="${state.budgets[category] || ''}" min="0" step="0.01" placeholder="0.00">
            `;
            budgetInputs.appendChild(div);
        });
        applyTranslations();
        new bootstrap.Modal(document.getElementById("setBudgetModal")).show();
    }

    /**
     * Opens the manage categories modal.
     */
    function openManageCategoriesModal() {
        document.getElementById("newCategoryInput").value = "";
        document.getElementById("newCategoryInput").classList.remove("is-invalid");
        populateCategoryList();
        new bootstrap.Modal(document.getElementById("manageCategoriesModal")).show();
    }

    /**
     * Adds a new custom category.
     */
    function addCategory() {
        const newCategoryInput = document.getElementById("newCategoryInput");
        const newCategory = newCategoryInput.value.trim();
        if (!newCategory) {
            newCategoryInput.classList.add("is-invalid");
            return;
        }
        if (state.categories.includes(newCategory)) {
            alert("Category already exists.");
            return;
        }
        state.categories.push(newCategory);
        saveCategories();
        populateCategoryList();
        newCategoryInput.value = "";
        newCategoryInput.classList.remove("is-invalid");
    }

    /**
     * Populates the category list in the manage categories modal.
     */
    function populateCategoryList() {
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = "";
        state.categories.forEach(category => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.textContent = category;
            if (!defaultCategories.includes(category)) {
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "btn btn-danger btn-sm";
                deleteBtn.textContent = "Delete";
                deleteBtn.onclick = () => deleteCategory(category);
                li.appendChild(deleteBtn);
            }
            categoryList.appendChild(li);
        });
    }

    /**
     * Deletes a custom category.
     */
    function deleteCategory(category) {
        if (confirm(getTranslation("deleteCategoryConfirm"))) {
            state.categories = state.categories.filter(cat => cat !== category);
            state.spendingEntries.forEach(entry => {
                if (entry.category === category) {
                    entry.category = "Other";
                }
            });
            delete state.budgets[category];
            saveCategories();
            saveSpendingEntries();
            localStorage.setItem("spendingBudgets", minifyJSON(state.budgets));
            populateCategoryList();
            populateCategoryDropdowns();
            showManageEntries();
            showSpendingSummary();
        }
    }

    /**
     * Populates category dropdowns in all modals.
     */
    function populateCategoryDropdowns() {
        const dropdowns = [
            document.getElementById("spendingCategory"),
            document.getElementById("editSpendingCategory"),
            document.getElementById("filterCategory")
        ];
        dropdowns.forEach(dropdown => {
            const selectedValue = dropdown.value;
            dropdown.innerHTML = dropdown.id === "filterCategory" ? '<option value="all" data-translate="all">All</option>' : '';
            state.categories.forEach(category => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                dropdown.appendChild(option);
            });
            dropdown.value = selectedValue in state.categories || dropdown.id !== "filterCategory" ? selectedValue : "all";
        });
        applyTranslations();
    }

    /**
     * Adds a new spending entry.
     */
    function addSpendingEntry() {
        const amountInput = document.getElementById("spendingAmount");
        const amount = parseFloat(amountInput.value);
        const type = document.getElementById("spendingType").value;
        const category = document.getElementById("spendingCategory").value;
        const date = document.getElementById("spendingDate").value;
        const recurrence = document.getElementById("spendingRecurrence").value;
        const currency = document.getElementById("spendingCurrency").value;

        if (isNaN(amount) || amount <= 0) {
            amountInput.classList.add("is-invalid");
            return;
        }
        amountInput.classList.remove("is-invalid");

        try {
            state.spendingEntries.push({
                amount,
                type,
                category,
                date,
                recurrence,
                currency,
                recurring: recurrence !== "none"
            });
            saveSpendingEntries();
            checkBudgetAlerts(category);
            bootstrap.Modal.getInstance(document.getElementById("spendingTrackerModal")).hide();
            alert("Spending entry added successfully!");
        } catch (e) {
            console.error("Failed to add spending entry:", e);
            alert("Failed to add spending entry. Please try again.");
        }
    }

    /**
     * Checks for recurring entries and generates new ones.
     */
    function checkRecurringEntries() {
        const today = new Date().toISOString().split("T")[0];
        state.spendingEntries.forEach((entry, index) => {
            if (entry.recurring && entry.date && new Date(entry.date) < new Date(today)) {
                const newDate = new Date(entry.date);
                if (entry.recurrence === "daily") {
                    newDate.setDate(newDate.getDate() + 1);
                } else if (entry.recurrence === "weekly") {
                    newDate.setDate(newDate.getDate() + 7);
                } else if (entry.recurrence === "monthly") {
                    newDate.setMonth(newDate.getMonth() + 1);
                }
                state.spendingEntries.push({
                    ...entry,
                    date: newDate.toISOString().split("T")[0],
                    recurring: true
                });
                state.spendingEntries[index].recurring = false;
            }
        });
        saveSpendingEntries();
        setTimeout(checkRecurringEntries, 5 * 60 * 1000);
    }

    /**
     * Checks if a category's budget is exceeded and triggers an alert.
     */
    function checkBudgetAlerts(category) {
        if (!state.budgets[category]) return;
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const monthlyExpenses = state.spendingEntries
            .filter(entry => {
                const entryDate = new Date(entry.date);
                return entry.type === "Expense" &&
                       entry.category === category &&
                       entryDate >= monthStart &&
                       entryDate <= monthEnd;
            })
            .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
        if (monthlyExpenses > state.budgets[category]) {
            const message = getTranslation("budgetExceeded")
                .replace("{category}", category)
                .replace("{spent}", monthlyExpenses.toFixed(2))
                .replace("{budget}", state.budgets[category].toFixed(2));
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Budget Alert', {
                    body: message,
                    icon: 'https://via.placeholder.com/32'
                });
            } else {
                alert(message);
            }
        }
    }

    /**
     * Shows the manage entries modal with a list of all spending entries.
     */
    function showManageEntries() {
        bootstrap.Modal.getInstance(document.getElementById("spendingTrackerModal")).hide();
        const entriesList = document.getElementById("spendingEntriesList");
        entriesList.innerHTML = "";

        // Apply filters
        let filteredEntries = [...state.spendingEntries];
        const searchQuery = document.getElementById("searchEntries").value.toLowerCase();
        const filterType = document.getElementById("filterType").value;
        const filterCategory = document.getElementById("filterCategory").value;
        const startDate = document.getElementById("filterStartDate").value;
        const endDate = document.getElementById("filterEndDate").value;

        if (searchQuery) {
            filteredEntries = filteredEntries.filter(entry =>
                entry.category.toLowerCase().includes(searchQuery) ||
                entry.type.toLowerCase().includes(searchQuery)
            );
        }
        if (filterType !== "all") {
            filteredEntries = filteredEntries.filter(entry => entry.type === filterType);
        }
        if (filterCategory !== "all") {
            filteredEntries = filteredEntries.filter(entry => entry.category === filterCategory);
        }
        if (startDate) {
            filteredEntries = filteredEntries.filter(entry => entry.date >= startDate);
        }
        if (endDate) {
            filteredEntries = filteredEntries.filter(entry => entry.date <= endDate);
        }

        if (filteredEntries.length === 0) {
            entriesList.innerHTML = `<tr><td colspan="5">${getTranslation("noEntries") || "No spending entries found."}</td></tr>`;
        } else {
            filteredEntries.forEach((entry, index) => {
                const convertedAmount = convertToDefaultCurrency(entry.amount, entry.currency);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.type}</td>
                    <td>${entry.category}</td>
                    <td>${convertedAmount.toFixed(2)} ${localStorage.getItem("defaultCurrency") || "NRs"} (Original: ${entry.amount.toFixed(2)} ${entry.currency})</td>
                    <td>
                        <button class="btn btn-warning btn-sm me-2" onclick="editSpendingEntry(${index})" data-translate="edit">Edit</button>
                        <button class="btn btn-danger btn-sm me-2" onclick="deleteSpendingEntry(${index})" data-translate="delete">Delete</button>
                        ${entry.recurring ? `<button class="btn btn-secondary btn-sm" onclick="stopRecurrence(${index})" data-translate="stopRecurrence">Stop Recurrence</button>` : ""}
                    </td>
                `;
                entriesList.appendChild(row);
            });
        }
        applyTranslations();
        new bootstrap.Modal(document.getElementById("manageEntriesModal")).show();
    }

    /**
     * Opens the edit spending entry modal.
     */
    window.editSpendingEntry = function(index) {
        currentEditSpendingIndex = index;
        const entry = state.spendingEntries[index];
        document.getElementById("editSpendingAmount").value = entry.amount;
        document.getElementById("editSpendingAmount").classList.remove("is-invalid");
        document.getElementById("editSpendingType").value = entry.type;
        document.getElementById("editSpendingCategory").value = entry.category;
        document.getElementById("editSpendingDate").value = entry.date;
        document.getElementById("editSpendingRecurrence").value = entry.recurrence;
        document.getElementById("editSpendingCurrency").value = entry.currency;
        new bootstrap.Modal(document.getElementById("editSpendingModal")).show();
    };

    /**
     * Saves the edited spending entry.
     */
    function saveEditedSpendingEntry() {
        const amountInput = document.getElementById("editSpendingAmount");
        const amount = parseFloat(amountInput.value);
        const type = document.getElementById("editSpendingType").value;
        const category = document.getElementById("editSpendingCategory").value;
        const date = document.getElementById("editSpendingDate").value;
        const recurrence = document.getElementById("editSpendingRecurrence").value;
        const currency = document.getElementById("editSpendingCurrency").value;

        if (isNaN(amount) || amount <= 0) {
            amountInput.classList.add("is-invalid");
            return;
        }
        amountInput.classList.remove("is-invalid");

        try {
            state.spendingEntries[currentEditSpendingIndex] = {
                amount,
                type,
                category,
                date,
                recurrence,
                currency,
                recurring: recurrence !== "none"
            };
            saveSpendingEntries();
            checkBudgetAlerts(category);
            bootstrap.Modal.getInstance(document.getElementById("editSpendingModal")).hide();
            showManageEntries();
            alert("Spending entry updated successfully!");
        } catch (e) {
            console.error("Failed to update spending entry:", e);
            alert("Failed to update spending entry. Please try again.");
        }
    }

    /**
     * Deletes a spending entry.
     */
    window.deleteSpendingEntry = function(index) {
        if (confirm("Are you sure you want to delete this spending entry?")) {
            try {
                state.spendingEntries.splice(index, 1);
                saveSpendingEntries();
                showManageEntries();
                alert("Spending entry deleted successfully!");
            } catch (e) {
                console.error("Failed to delete spending entry:", e);
                alert("Failed to delete spending entry. Please try again.");
            }
        }
    };

    /**
     * Stops recurrence for a spending entry.
     */
    window.stopRecurrence = function(index) {
        state.spendingEntries[index].recurring = false;
        state.spendingEntries[index].recurrence = "none";
        saveSpendingEntries();
        showManageEntries();
    };

    /**
     * Exports spending entries to an Excel file.
     */
    function exportSpendingToExcel() {
        if (state.spendingEntries.length === 0) {
            alert("No spending entries to export.");
            return;
        }
        try {
            const defaultCurrency = localStorage.getItem("defaultCurrency") || "NRs";
            const worksheet = XLSX.utils.json_to_sheet(state.spendingEntries.map(entry => ({
                Date: entry.date,
                Type: entry.type,
                Category: entry.category,
                Amount: convertToDefaultCurrency(entry.amount, entry.currency),
                Currency: defaultCurrency,
                OriginalAmount: entry.amount,
                OriginalCurrency: entry.currency
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Spending Entries");
            XLSX.writeFile(workbook, "Spending_Entries.xlsx");
        } catch (e) {
            console.error("Export failed:", e);
            alert("Failed to export spending entries. Please try again.");
        }
    }

    /**
     * Exports spending summaries to a PDF.
     */
    function exportSpendingToPDF() {
        try {
            const doc = new jsPDF();
            doc.text(getTranslation("viewSummary"), 10, 10);
            let y = 20;

            // Budget Overview
            doc.text(getTranslation("budgetTitle"), 10, y);
            y += 10;
            Object.keys(state.budgets).forEach(category => {
                const spent = calculateMonthlyExpenses(category);
                doc.text(`${getTranslation("budgetFor")} ${category}: ${state.budgets[category].toFixed(2)} ${localStorage.getItem("defaultCurrency") || "NRs"} (Spent: ${spent.toFixed(2)})`, 10, y);
                y += 10;
            });
            if (Object.keys(state.budgets).length === 0) {
                doc.text(getTranslation("noBudgetSet"), 10, y);
                y += 10;
            }
            y += 10;

            // Weekly Summary
            doc.text(getTranslation("weeklySummary"), 10, y);
            y += 10;
            const weeklyTable = document.getElementById("weeklySummary").innerHTML;
            doc.html(`<table>${weeklyTable}</table>`, { x: 10, y: y });
            y += 50;

            // Monthly Summary
            doc.text(getTranslation("monthlySummary"), 10, y);
            y += 10;
            const monthlyTable = document.getElementById("monthlySummary").innerHTML;
            doc.html(`<table>${monthlyTable}</table>`, { x: 10, y: y });
            y += 30;

            // Yearly Summary
            doc.text(getTranslation("yearlySummary"), 10, y);
            y += 10;
            const yearlyTable = document.getElementById("yearlySummary").innerHTML;
            doc.html(`<table>${yearlyTable}</table>`, { x: 10, y: y });

            doc.save("Spending_Summary.pdf");
        } catch (e) {
            console.error("PDF export failed:", e);
            alert("Failed to export to PDF. Please try again.");
        }
    }

    /**
     * Calculates monthly expenses for a category.
     */
    function calculateMonthlyExpenses(category) {
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        return state.spendingEntries
            .filter(entry => {
                const entryDate = new Date(entry.date);
                return entry.type === "Expense" &&
                       entry.category === category &&
                       entryDate >= monthStart &&
                       entryDate <= monthEnd;
            })
            .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
    }

    /**
     * Updates charts based on the current theme.
     */
    function updateCharts() {
        const isDarkMode = document.documentElement.getAttribute("data-theme") === "dark";
        const chartTextColor = isDarkMode ? "#f8f9fa" : "#212529";
        const chartBgColor = isDarkMode ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";

        if (categoryPieChart) {
            categoryPieChart.data.datasets[0].backgroundColor = state.categories.map((_, i) =>
                `hsl(${(i * 360 / state.categories.length) % 360}, 70%, ${isDarkMode ? 60 : 50}%)`
            );
            categoryPieChart.options.plugins.legend.labels.color = chartTextColor;
            categoryPieChart.options.plugins.title.color = chartTextColor;
            categoryPieChart.update();
        }

        if (monthlyTrendsChart) {
            monthlyTrendsChart.data.datasets.forEach(dataset => {
                dataset.borderColor = dataset.label === getTranslation("incomeLabel") ? (isDarkMode ? "#28a745" : "#28a745") : (isDarkMode ? "#dc3545" : "#dc3545");
                dataset.backgroundColor = dataset.label === getTranslation("incomeLabel") ? (isDarkMode ? "rgba(40, 167, 69, 0.2)" : "rgba(40, 167, 69, 0.2)") : (isDarkMode ? "rgba(220, 53, 69, 0.2)" : "rgba(220, 53, 69, 0.2)");
            });
            monthlyTrendsChart.options.scales.x.title.color = chartTextColor;
            monthlyTrendsChart.options.scales.y.title.color = chartTextColor;
            monthlyTrendsChart.options.scales.x.ticks.color = chartTextColor;
            monthlyTrendsChart.options.scales.y.ticks.color = chartTextColor;
            monthlyTrendsChart.options.plugins.legend.labels.color = chartTextColor;
            monthlyTrendsChart.options.plugins.title.color = chartTextColor;
            monthlyTrendsChart.options.elements.line.backgroundColor = chartBgColor;
            monthlyTrendsChart.update();
        }
    }

    /**
     * Shows the spending summary modal with weekly, monthly, yearly summaries, budgets, and charts.
     */
    function showSpendingSummary() {
        bootstrap.Modal.getInstance(document.getElementById("spendingTrackerModal"))?.hide();
        const now = new Date();
        const defaultCurrency = localStorage.getItem("defaultCurrency") || "NRs";

        // Budget Overview
        const budgetOverview = document.getElementById("budgetOverview");
        budgetOverview.innerHTML = "";
        if (Object.keys(state.budgets).length === 0) {
            budgetOverview.innerHTML = `<p>${getTranslation("noBudgetSet")}</p>`;
        } else {
            Object.keys(state.budgets).forEach(category => {
                const spent = calculateMonthlyExpenses(category);
                const budget = state.budgets[category];
                const percentage = (spent / budget) * 100;
                const div = document.createElement("div");
                div.innerHTML = `
                    <p>${getTranslation("budgetFor")} ${category}: ${budget.toFixed(2)} ${defaultCurrency}</p>
                    <div class="progress">
                        <div class="progress-bar ${percentage > 100 ? 'bg-danger' : percentage > 80 ? 'bg-warning' : 'bg-success'}" role="progressbar" style="width: ${Math.min(percentage, 100)}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${spent.toFixed(2)} (${percentage.toFixed(1)}%)</div>
                    </div>
                `;
                budgetOverview.appendChild(div);
            });
        }

        // Weekly Summary by Day
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        const weeklySummaryTable = document.getElementById("weeklySummary");
        weeklySummaryTable.innerHTML = "";
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        for (let i = 0; i < 7; i++) {
            const currentDay = new Date(weekStart);
            currentDay.setDate(weekStart.getDate() + i);
            const dayString = currentDay.toISOString().split("T")[0];
            const dayEntries = state.spendingEntries.filter(entry => entry.date === dayString);
            const income = dayEntries
                .filter(entry => entry.type === "Income")
                .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
            const expenses = dayEntries
                .filter(entry => entry.type === "Expense")
                .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
            const balance = income - expenses;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${days[i]} (${dayString})</td>
                <td>${income.toFixed(2)} ${defaultCurrency}</td>
                <td>${expenses.toFixed(2)} ${defaultCurrency}</td>
                <td>${balance.toFixed(2)} ${defaultCurrency}</td>
            `;
            weeklySummaryTable.appendChild(row);
        }

        // Monthly Summary
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const monthlyEntries = state.spendingEntries.filter(entry => {
            const entryDate = new Date(entry.date);
            return entryDate >= monthStart && entryDate <= monthEnd;
        });
        const monthlyIncome = monthlyEntries
            .filter(entry => entry.type === "Income")
            .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
        const monthlyExpenses = monthlyEntries
            .filter(entry => entry.type === "Expense")
            .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
        document.getElementById("monthlySummary").innerHTML = `
            <tr>
                <td>${monthlyIncome.toFixed(2)} ${defaultCurrency}</td>
                <td>${monthlyExpenses.toFixed(2)} ${defaultCurrency}</td>
                <td>${(monthlyIncome - monthlyExpenses).toFixed(2)} ${defaultCurrency}</td>
            </tr>
        `;

        // Yearly Summary
        const yearStart = new Date(now.getFullYear(), 0, 1);
        const yearEnd = new Date(now.getFullYear(), 11, 31);
        const yearlyEntries = state.spendingEntries.filter(entry => {
            const entryDate = new Date(entry.date);
            return entryDate >= yearStart && entryDate <= yearEnd;
        });
        const yearlyIncome = yearlyEntries
            .filter(entry => entry.type === "Income")
            .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
        const yearlyExpenses = yearlyEntries
            .filter(entry => entry.type === "Expense")
            .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
        document.getElementById("yearlySummary").innerHTML = `
            <tr>
                <td>${yearlyIncome.toFixed(2)} ${defaultCurrency}</td>
                <td>${yearlyExpenses.toFixed(2)} ${defaultCurrency}</td>
                <td>${(yearlyIncome - yearlyExpenses).toFixed(2)} ${defaultCurrency}</td>
            </tr>
        `;

        // Category-wise Expenses Pie Chart
        const categoryExpenses = {};
        state.categories.forEach(category => {
            categoryExpenses[category] = monthlyEntries
                .filter(entry => entry.type === "Expense" && entry.category === category)
                .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0);
        });
        const isDarkMode = document.documentElement.getAttribute("data-theme") === "dark";
        if (categoryPieChart) categoryPieChart.destroy();
        categoryPieChart = new Chart(document.getElementById("categoryPieChart"), {
            type: 'pie',
            data: {
                labels: state.categories,
                datasets: [{
                    data: state.categories.map(cat => categoryExpenses[cat]),
                    backgroundColor: state.categories.map((_, i) => `hsl(${(i * 360 / state.categories.length) % 360}, 70%, ${isDarkMode ? 60 : 50}%)`)
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: isDarkMode ? "#f8f9fa" : "#212529"
                        }
                    },
                    title: {
                        display: true,
                        text: getTranslation("categoryWiseExpenses"),
                        color: isDarkMode ? "#f8f9fa" : "#212529"
                    }
                }
            }
        });

        // Monthly Trends Line Chart (Last 6 Months)
        const months = [];
        const incomes = [];
        const expenses = [];
        for (let i = 5; i >= 0; i--) {
            const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
            const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
            const monthEntries = state.spendingEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= monthStart && entryDate <= monthEnd;
            });
            months.push(monthDate.toLocaleString('default', { month: 'short', year: 'numeric' }));
            incomes.push(monthEntries
                .filter(entry => entry.type === "Income")
                .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0));
            expenses.push(monthEntries
                .filter(entry => entry.type === "Expense")
                .reduce((sum, entry) => sum + convertToDefaultCurrency(entry.amount, entry.currency), 0));
        }
        if (monthlyTrendsChart) monthlyTrendsChart.destroy();
        monthlyTrendsChart = new Chart(document.getElementById("monthlyTrendsChart"), {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: getTranslation("incomeLabel"),
                        data: incomes,
                        borderColor: isDarkMode ? "#28a745" : "#28a745",
                        backgroundColor: isDarkMode ? "rgba(40, 167, 69, 0.2)" : "rgba(40, 167, 69, 0.2)",
                        fill: true
                    },
                    {
                        label: getTranslation("expenses"),
                        data: expenses,
borderColor: isDarkMode ? "#dc3545" : "#dc3545",
                        backgroundColor: isDarkMode ? "rgba(220, 53, 69, 0.2)" : "rgba(220, 53, 69, 0.2)",
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: isDarkMode ? "#f8f9fa" : "#212529"
                        }
                    },
                    title: {
                        display: true,
                        text: getTranslation("monthlyTrends"),
                        color: isDarkMode ? "#f8f9fa" : "#212529"
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Months',
                            color: isDarkMode ? "#f8f9fa" : "#212529"
                        },
                        ticks: {
                            color: isDarkMode ? "#f8f9fa" : "#212529"
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: `Amount (${defaultCurrency})`,
                            color: isDarkMode ? "#f8f9fa" : "#212529"
                        },
                        ticks: {
                            color: isDarkMode ? "#f8f9fa" : "#212529"
                        },
                        beginAtZero: true
                    }
                },
                elements: {
                    line: {
                        backgroundColor: isDarkMode ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)"
                    }
                }
            }
        });

        applyTranslations();
        new bootstrap.Modal(document.getElementById("spendingSummaryModal")).show();
    }

    // Expose functions to global scope for inline event handlers
    window.editSpendingEntry = editSpendingEntry;
    window.deleteSpendingEntry = deleteSpendingEntry;
    window.stopRecurrence = stopRecurrence;
})();
    </script>
</body>
</html>