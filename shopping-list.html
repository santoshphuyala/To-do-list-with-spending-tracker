<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="icon" href="data:,">
    <style>
        :root {
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: gray;
            --accent-bg: #e9ecef;
            --button-hover-bg: #0056b3;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #218838;
            --button-danger-bg: #dc3545;
            --button-danger-hover-bg: #c82333;
            --navbar-bg: #ffffff;
            --navbar-text: #212529;
            --navbar-hover-bg: #e9ecef;
        }
        [data-theme="dark"] {
            --background-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: #495057;
            --button-bg: #0d6efd;
            --button-text: #ffffff;
            --completed-text: #adb5bd;
            --accent-bg: #495057;
            --button-hover-bg: #1a73e8;
            --button-success-bg: #28a745;
            --button-success-hover-bg: #2ecc71;
            --button-danger-bg: #dc3545;
            --button-danger-hover-bg: #c82333;
            --navbar-bg: #343a40;
            --navbar-text: #f8f9fa;
            --navbar-hover-bg: #495057;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .container, .list-group-item, .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .completed {
            text-decoration: line-through;
            color: var(--completed-text);
        }
        .btn-primary, .btn-success, .btn-danger, .btn-warning {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--button-hover-bg);
        }
        .btn-success {
            background-color: var(--button-success-bg);
        }
        .btn-success:hover {
            background-color: var(--button-success-hover-bg);
        }
        .btn-danger {
            background-color: var(--button-danger-bg);
        }
        .btn-danger:hover {
            background-color: var(--button-danger-hover-bg);
        }
        .action-buttons {
            background-color: var(--accent-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .action-buttons .btn {
            margin: 5px;
        }
        .navbar {
            background-color: var(--navbar-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand, .nav-link, .dropdown-item {
            color: var(--navbar-text) !important;
        }
        .dropdown-item:hover {
            background-color: var(--navbar-hover-bg);
        }
        .dropdown-item.active {
            background-color: var(--button-bg);
            color: var(--button-text) !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">Task & Expense Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Navigate
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="index.html">Home</a></li>
                            <li><a class="dropdown-item" href="todo-list.html">To-Do List</a></li>
                            <li><a class="dropdown-item" href="spending-tracker.html">Spending Tracker</a></li>
                            <li><a class="dropdown-item active" href="shopping-list.html">Shopping List</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-primary" id="themeToggleBtn">Toggle Theme</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="mb-4">Shopping List</h1>
        <div class="action-buttons">
            <div class="input-group mb-3">
                <input type="text" id="itemInput" class="form-control" placeholder="Add a new item" aria-label="Item description">
                <div class="invalid-feedback">Please enter an item name.</div>
                <input type="number" id="itemQuantity" class="form-control" placeholder="Qty" min="1" step="1" value="1" aria-label="Item quantity">
                <button class="btn btn-primary" id="addItemBtn">Add Item</button>
            </div>
            <div class="d-flex flex-wrap">
                <button class="btn btn-success" id="markAllPurchasedBtn">Mark All Purchased</button>
                <button class="btn btn-danger" id="deleteAllBtn">Delete All</button>
                <button class="btn btn-warning" id="exportExcelBtn">Export to Excel</button>
            </div>
        </div>

        <!-- Shopping List -->
        <ul id="shoppingList" class="list-group mb-3" role="list" aria-live="polite"></ul>
    </div>

    <!-- Edit Item Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editItemInput" class="form-label">Item Name</label>
                        <input type="text" id="editItemInput" class="form-control" aria-label="Edit item name">
                        <div class="invalid-feedback">Item name cannot be empty.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editItemQuantity" class="form-label">Quantity</label>
                        <input type="number" id="editItemQuantity" class="form-control" min="1" step="1" aria-label="Edit item quantity">
                        <div class="invalid-feedback">Please enter a valid quantity.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script src="lib/xlsx.full.min.js"></script>
    <script src="lib/purify.min.js"></script>
    <script src="utility.js"></script>
    <script>
(function () {
    // State management
    const state = {
        items: [],
    };

    let currentEditIndex = null;

    // Fallback sanitization if DOMPurify fails
    function sanitizeInput(input) {
        if (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function') {
            return DOMPurify.sanitize(input);
        }
        return input.replace(/<[^>]+>/g, '');
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
        try {
            const storedItems = localStorage.getItem("shoppingItems");
            if (storedItems) {
                state.items = parseMinifiedJSON(storedItems);
            }
        } catch (e) {
            console.error("Failed to load shopping items:", e);
            alert("Failed to load shopping items. Please try again.");
        }
        applyTheme();
        initializeEventListeners();
        loadItems();
    });

    // Theme Toggle
    document.getElementById("themeToggleBtn").addEventListener("click", toggleTheme);

    /**
     * Initializes all event listeners for buttons and inputs.
     */
    function initializeEventListeners() {
        document.getElementById("addItemBtn").addEventListener("click", addItem);
        document.getElementById("markAllPurchasedBtn").addEventListener("click", markAllPurchased);
        document.getElementById("deleteAllBtn").addEventListener("click", deleteAllItems);
        document.getElementById("exportExcelBtn").addEventListener("click", exportToExcel);
        document.getElementById("saveEditBtn").addEventListener("click", saveEditedItem);
    }

    /**
     * Saves items to localStorage with compression.
     */
    function saveItems() {
        try {
            if (state.items.length > 1000) {
                state.items = state.items.slice(-1000);
                console.warn("Shopping items exceeded 1000; older items have been removed.");
            }
            if (!checkStorageCapacity()) {
                state.items = state.items.slice(-500); // Reduce items to free up space
                console.warn("Reduced item list to avoid storage issues.");
            }
            localStorage.setItem("shoppingItems", minifyJSON(state.items));
        } catch (e) {
            console.error("Failed to save shopping items:", e);
            alert("Failed to save shopping items. Please try again.");
        }
    }

    /**
     * Adds a new item to the list.
     */
    function addItem() {
        const itemInput = document.getElementById("itemInput");
        const itemText = itemInput.value.trim();
        const itemQuantity = parseInt(document.getElementById("itemQuantity").value, 10);

        if (!itemText) {
            itemInput.classList.add("is-invalid");
            return;
        }
        if (isNaN(itemQuantity) || itemQuantity < 1) {
            document.getElementById("itemQuantity").classList.add("is-invalid");
            return;
        }

        itemInput.classList.remove("is-invalid");
        document.getElementById("itemQuantity").classList.remove("is-invalid");

        try {
            state.items.push({
                text: sanitizeInput(itemText),
                quantity: itemQuantity,
                purchased: false
            });
            saveItems();
            resetInputs();
            loadItems();
        } catch (e) {
            console.error("Failed to add item:", e);
            alert("Failed to add item. Please try again.");
        }
    }

    /**
     * Resets input fields to default values.
     */
    function resetInputs() {
        const itemInput = document.getElementById("itemInput");
        itemInput.value = "";
        itemInput.classList.remove("is-invalid");
        document.getElementById("itemQuantity").value = "1";
        document.getElementById("itemQuantity").classList.remove("is-invalid");
    }

    /**
     * Loads and displays shopping items.
     */
    function loadItems() {
        const shoppingList = document.getElementById("shoppingList");
        shoppingList.innerHTML = "";
        state.items.forEach((item, index) => {
            const itemElement = document.createElement("li");
            itemElement.className = `list-group-item d-flex justify-content-between align-items-center ${item.purchased ? "completed" : ""}`;
            itemElement.setAttribute("role", "listitem");

            const itemInfo = document.createElement("span");
            itemInfo.textContent = `${item.text} (Qty: ${item.quantity})`;
            itemElement.appendChild(itemInfo);

            const buttonGroup = document.createElement("div");
            const purchaseBtn = document.createElement("button");
            purchaseBtn.className = "btn btn-success btn-sm me-2";
            purchaseBtn.textContent = "✔";
            purchaseBtn.setAttribute("aria-label", "Mark Purchased");
            purchaseBtn.onclick = () => markPurchased(index);

            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-warning btn-sm me-2";
            editBtn.textContent = "✏";
            editBtn.setAttribute("aria-label", "Edit Item");
            editBtn.onclick = () => editItem(index);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn btn-danger btn-sm";
            deleteBtn.textContent = "🗑";
            deleteBtn.setAttribute("aria-label", "Delete Item");
            deleteBtn.onclick = () => deleteItem(index);

            buttonGroup.append(purchaseBtn, editBtn, deleteBtn);
            itemElement.appendChild(buttonGroup);

            shoppingList.appendChild(itemElement);
        });
    }

    /**
     * Marks an item as purchased or not.
     * @param {number} index - Index of the item.
     */
    function markPurchased(index) {
        try {
            state.items[index].purchased = !state.items[index].purchased;
            saveItems();
            loadItems();
        } catch (e) {
            console.error("Failed to mark item purchased:", e);
            alert("Failed to update item. Please try again.");
        }
    }

    /**
     * Opens the edit item modal and populates fields.
     * @param {number} index - Index of the item.
     */
    function editItem(index) {
        currentEditIndex = index;
        const item = state.items[index];
        const editInput = document.getElementById("editItemInput");
        editInput.value = item.text;
        editInput.classList.remove("is-invalid");
        document.getElementById("editItemQuantity").value = item.quantity;
        new bootstrap.Modal(document.getElementById("editItemModal")).show();
    }

    /**
     * Saves the edited item.
     */
    function saveEditedItem() {
        const editInput = document.getElementById("editItemInput");
        const newText = editInput.value.trim();
        const newQuantity = parseInt(document.getElementById("editItemQuantity").value, 10);

        if (!newText) {
            editInput.classList.add("is-invalid");
            return;
        }
        if (isNaN(newQuantity) || newQuantity < 1) {
            document.getElementById("editItemQuantity").classList.add("is-invalid");
            return;
        }

        try {
            state.items[currentEditIndex] = {
                ...state.items[currentEditIndex],
                text: sanitizeInput(newText),
                quantity: newQuantity
            };
            saveItems();
            loadItems();
            bootstrap.Modal.getInstance(document.getElementById("editItemModal")).hide();
        } catch (e) {
            console.error("Failed to save edited item:", e);
            alert("Failed to save item. Please try again.");
        }
    }

    /**
     * Deletes an item.
     * @param {number} index - Index of the item.
     */
    function deleteItem(index) {
        try {
            state.items.splice(index, 1);
            saveItems();
            loadItems();
        } catch (e) {
            console.error("Failed to delete item:", e);
            alert("Failed to delete item. Please try again.");
        }
    }

    /**
     * Marks all items as purchased.
     */
    function markAllPurchased() {
        try {
            state.items.forEach(item => item.purchased = true);
            saveItems();
            loadItems();
        } catch (e) {
            console.error("Failed to mark all items purchased:", e);
            alert("Failed to update items. Please try again.");
        }
    }

    /**
     * Deletes all items after confirmation.
     */
    function deleteAllItems() {
        if (confirm("Are you sure you want to delete all items?")) {
            try {
                state.items = [];
                saveItems();
                loadItems();
            } catch (e) {
                console.error("Failed to delete all items:", e);
                alert("Failed to delete all items. Please try again.");
            }
        }
    }

    /**
     * Exports items to an Excel file.
     */
    function exportToExcel() {
        if (state.items.length === 0) {
            alert("No items to export.");
            return;
        }
        try {
            const worksheet = XLSX.utils.json_to_sheet(state.items);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Shopping List");
            XLSX.writeFile(workbook, "Shopping_List.xlsx");
        } catch (e) {
            console.error("Export failed:", e);
            alert("Failed to export items. Please try again.");
        }
    }
})();
    </script>
</body>
</html>